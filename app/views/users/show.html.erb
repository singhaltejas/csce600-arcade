<%= render "games/all_pages_nav" %>

<% if @current_user.spotify_username.present? %>
  <% user_id = @current_user.spotify_username %>
  <% access_token = session[:spotify_access_token] %>

  <% uri = URI.parse("https://api.spotify.com/v1/users/#{user_id}/playlists") %>
  <% http = Net::HTTP.new(uri.host, uri.port) %>
  <% http.use_ssl = true %>
  
  <% request = Net::HTTP::Get.new(uri.request_uri) %>
  <% request["Authorization"] = "Bearer #{access_token}" %>
  
  <% response = http.request(request) %>
  <% playlists_data = JSON.parse(response.body) %>
  <%= playlists_data %>

  <% if playlists_data["items"].any? %>
    <% random_playlist = playlists_data["items"].sample %>
    <% random_playlist_id = random_playlist["id"] %>
    <div id="spotify-player-container"></div>
    <script>
      document.getElementById('spotify-player-container').innerHTML = `
        <iframe src="https://open.spotify.com/embed/playlist/<%= random_playlist_id %>" 
                width="300" height="380" frameborder="0" allowtransparency="true" allow="encrypted-media"></iframe>
      `;
    </script>
  <% else %>
    <div id="spotify-player-container"></div>
    <script>
      document.getElementById('spotify-player-container').innerHTML = `
        <iframe style="border-radius:12px" src="https://open.spotify.com/embed/playlist/1UbVSMJFbBMW8G3J5wUOvu?utm_source=generator" 
                width="100%" height="352" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>
      `;
    </script>
  <% end %>
<% end %>

<div class="profile-container">
  <h3>Profile Information</h3>
  <div class="profile-section">
    <p class="sso-info"><strong>First Name:</strong> <%= @current_user.first_name %></p>
    <p class="sso-info"><strong>Last Name:</strong> <%= @current_user.last_name %></p>
  </div>

  <h3>Connected Accounts</h3>
  <div class="sso-account">
    <div class="sso-btns">
      <button class="sso-btn sso-logo">
        <i class="fab fa-google"></i>
      </button>
      <% if @current_user.email.present? && (@current_user.spotify_username.blank? && @current_user.github_username.blank?) %>
        <button class="sso-btn sso-no"><i class="fas fa-unlink"></i></button>
      <% else %>
        <%= button_to @current_user.email.present? ? user_path(@current_user) : "/auth/google_oauth2", 
          method: @current_user.email.present? ? :patch : :post, 
          params: @current_user.email.present? ? { user: { email: nil } } : {}, 
          class: @current_user.email.present? ? "sso-btn dis-btn" : "sso-btn con-btn", 
          data: { confirm: @current_user.email.present? ? 'Are you sure you want to unlink your Google account?' : nil } do %>
          <% if @current_user.email.present? %><i class="fas fa-unlink"></i>
          <% else %><i class="fas fa-link"></i>
          <% end %>
        <% end %>
      <% end %>
      <span class="sso-info"><%= @current_user.email.present? ? @current_user.email : '' %></span>
    </div>

    <div class="sso-btns">
      <button class="sso-btn sso-logo">
        <i class="fab fa-spotify"></i>
      </button>
      <% if @current_user.spotify_username.present? && (@current_user.email.blank? && @current_user.github_username.blank?) %>
        <button class="sso-btn sso-no"><i class="fas fa-unlink"></i></button>
      <% else %>
        <%= button_to @current_user.spotify_username.present? ? user_path(@current_user) : "/auth/spotify", 
          method: @current_user.spotify_username.present? ? :patch : :post, 
          params: @current_user.spotify_username.present? ? { user: { spotify_username: nil } } : {}, 
          class: @current_user.spotify_username.present? ? "sso-btn dis-btn" : "sso-btn con-btn", 
          data: { confirm: @current_user.spotify_username.present? ? 'Are you sure you want to unlink your Spotify account?' : nil } do %>
          <% if @current_user.spotify_username.present? %><i class="fas fa-unlink"></i>
          <% else %><i class="fas fa-link"></i>
          <% end %>
        <% end %>
      <% end %>
      <span class="sso-info"><%= @current_user.spotify_username.present? ? @current_user.spotify_username : '' %></span>
    </div>

    <div class="sso-btns">
      <button class="sso-btn sso-logo">
        <i class="fab fa-github"></i>
      </button>
      <% if @current_user.github_username.present? && (@current_user.email.blank? && @current_user.spotify_username.blank?) %>
        <button class="sso-btn sso-no"><i class="fas fa-unlink"></i></button>
      <% else %>
        <%= button_to @current_user.github_username.present? ? user_path(@current_user) : "/auth/github?allow_signup=true", 
          method: @current_user.github_username.present? ? :patch : :post, 
          params: @current_user.github_username.present? ? { user: { github_username: nil } } : {}, 
          class: @current_user.github_username.present? ? "sso-btn dis-btn" : "sso-btn con-btn", 
          data: { confirm: @current_user.github_username.present? ? 'Are you sure you want to unlink your GitHub account?' : nil } do %>
          <% if @current_user.github_username.present? %><i class="fas fa-unlink"></i>
          <% else %><i class="fas fa-link"></i>
          <% end %>
        <% end %>
      <% end %>
      <span class="sso-info"><%= @current_user.github_username.present? ? @current_user.github_username : '' %></span>
    </div>
  </div>

  <h3>Profile Options</h3>
  <div class="user-options">
    <%= button_to edit_user_path(@current_user), method: :get, class: "btn btn-login" do %>
      <i class="fas fa-pencil-alt"></i>
    <% end %>
    <%= button_to user_path(@current_user), method: :delete, data: { confirm: 'Are you sure you want to delete your account?' }, class: "btn btn-login dis-btn" do %>
      <i class="fas fa-trash"></i>
    <% end %>
  </div>
</div>