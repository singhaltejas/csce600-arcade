<%= render "shared/all_pages_nav" %>

<div class="profile-container">
  <h3>Manage Roles for '<%= "#{@current_user.first_name} #{@current_user.last_name}" %>'</h3>
  <% if @current_user.errors.any? %>
    <div style="color: red">
      <h2><%= pluralize(@current_user.errors.count, "error") %> prohibited this user from being saved:</h2>

      <ul>
        <% @current_user.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>
  <table class="role-table">
    <caption>Manage Roles</caption>
    <thead>
      <tr>
        <% ["Role", "Games", "Options"].each do |attr| %>
          <th style="color:white;">
            <%= attr.capitalize.sub("_", " ") %>
          </th>
        <% end %>
      </tr>
    </thead>
    <tbody>
      <!-- REPLACE THIS WITH Roles.all_roles -->
      <% Role.all_roles.each do |role_name| %>
        <% roles = Role.where(user_id: @current_user.id, role: role_name) %>
        <tr>
          <td><%= role_name %></td>
          <td>
            <% if Role.game_roles.include? role_name %>
              <% Game.all_games.each do |game_name| %>
                <% game = Game.find_by(name: game_name) %>
                <% role = Role.find_by(user_id: @current_user.id, role: role_name, game_id: game.id) %>
                <% if role %>
                <div class="role-block">
                  <%= game_name %>
                  <%= link_to("/roles/#{role.id}", title: "Remove Role", method: :delete, class: "btn role-delete-btn") do %>
                    <i class="fas fa-trash"></i>
                  <% end %>
                <% end %>
                </div>
              <% end %>
              <div class="dropdown">
                <a id="add_game" title="Add Game", class="btn role-add-game-btn">+ Add Game</a>
                <div class="dropdown-content">
                    <%= link_to dashboard_path do %><i class="fas fa-chart-bar"></i> Statistics<% end %>
                    
                    <%= link_to user_path(@current_user) do %><i class="fas fa-user-circle"></i> Profile<% end %>
                    
                    <%= link_to logout_path do %><i class="fas fa-sign-out-alt"></i> Log Out<% end %>
                </div>
            </div>
            <% else %>
              -
            <% end %>
          </td>
          <td>
            <% if not roles.empty? %>
              <% if Role.game_roles.include? role_name %>
                <%= link_to("Remove All", Role, params: {role: role_name}, method: :destroy_all, class: "btn role-delete-btn") %>
              <% else %>
                <%= link_to("Remove Role", "/roles/#{roles.first.id}", title: "Remove Role", method: :delete, class: "btn role-delete-btn") %>
              <% end %>
            <% elsif not Role.game_roles.include? role_name %>
              <%= link_to("Assign Role", roles_path(role: role_name), method: :post, class: "btn role-assn-btn") %>
            <% end %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
  <br>
  <br>
